<!-- Copyright (c)  Microsoft.  All Rights Reserved.  Licensed under the Apache License, Version 2.0.  See License.txt in the project root for license information. -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net461</TargetFramework>
    <IsProductComponent>false</IsProductComponent>
    <!-- 
         Disable following error. The error is reported because an analyzer in the referenced Microsoft.ML nuget package is referencing v2.9.0 of the Roslyn nuget package.
         However, this repo is being compiled with an older toolset compiler that's based on v2.7.0 of Roslyn. So the toolset compiler fails to run the analyzer.

           error CS8032: An instance of analyzer Microsoft.ML.Analyzer.TypeIsSchemaShapeAnalyzer cannot be created from Microsoft.ML.Analyzer.dll
           Could not load file or assembly 'Microsoft.CodeAnalysis, Version=2.9.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35' or one of its dependencies.
           The system cannot find the file specified.

        TODO: Remove this NoWarn if Microsoft.ML analyzer switches to an older version of Roslyn or once we upgrade this repo to compile with newer toolset compiler.
    -->
    <NoWarn>8032</NoWarn>
  </PropertyGroup>

  <ItemGroup>
    <None Include="Content\**" />
    <VSTemplate Include="Content\ConsoleApp\MLNETConsoleApplication.vstemplate">
      <OutputSubPath>Machine Learning</OutputSubPath>
    </VSTemplate>
  </ItemGroup>

  <ItemGroup>
    <None Include="Content\**" />
    <VSTemplate Include="Content\Library\MLNETModelLibrary.vstemplate">
      <OutputSubPath>Machine Learning</OutputSubPath>
    </VSTemplate>
  </ItemGroup>

  <!-- Nuget Packages To Include In VSIX -->
  <ItemGroup>
    <PackageReference Include="Microsoft.ML" Version="[$(MicrosoftMLVersion)]" />
    <PackageReference Include="Microsoft.ML.CpuMath" Version="[$(MicrosoftMLCpuMathVersion)]" />
  </ItemGroup>
  
  <Target BeforeTargets="CreateVsixContainer" Name="MakeVsixOutputDirectory">
    <MakeDir Condition="!Exists('$(OutDir)$(VsixOutDirSuffix)')" Directories="$(OutDir)$(VsixOutDirSuffix)" />
  </Target>

  <Target Name="GetVsixTemplateItems" DependsOnTargets="ZipProjects;ZipItems">
    
    <!-- Locate packages -->
    <ItemGroup>
      <MicrosoftMLPackage
        Condition="Exists('C:\Program Files\dotnet\sdk\NuGetFallbackFolder\Microsoft.ML$(MicrosoftMLVersion)\Microsoft.ML.$(MicrosoftMLVersion).nupkg')"
        Include="C:\Program Files\dotnet\sdk\NuGetFallbackFolder\Microsoft.ML\$(MicrosoftMLVersion)\Microsoft.ML.$(MicrosoftMLVersion).nupkg" />
      <MicrosoftMLPackage
        Condition="Exists('$(NuGetPackageRoot)Microsoft.ML\$(MicrosoftMLVersion)\Microsoft.ML.$(MicrosoftMLVersion).nupkg')"
        Include="$(NuGetPackageRoot)Microsoft.ML\$(MicrosoftMLVersion)\Microsoft.ML.$(MicrosoftMLVersion).nupkg" />

      <MicrosoftMLCpuMathPackage
        Condition="Exists('C:\Program Files\dotnet\sdk\NuGetFallbackFolder\Microsoft.ML.CpuMath\$(MicrosoftMLCpuMathVersion)\Microsoft.ML.CpuMath.$(MicrosoftMLCpuMathVersion).nupkg')"
        Include="C:\Program Files\dotnet\sdk\NuGetFallbackFolder\Microsoft.ML.CpuMath\$(MicrosoftMLCpuMathVersion)\Microsoft.ML.CpuMath.$(MicrosoftMLCpuMathVersion).nupkg" />
      <MicrosoftMLCpuMathPackage 
        Condition="Exists('$(NuGetPackageRoot)Microsoft.ML.CpuMath\$(MicrosoftMLCpuMathVersion)\Microsoft.ML.CpuMath.$(MicrosoftMLCpuMathVersion).nupkg')"
        Include="$(NuGetPackageRoot)Microsoft.ML.CpuMath\$(MicrosoftMLCpuMathVersion)\Microsoft.ML.CpuMath.$(MicrosoftMLCpuMathVersion).nupkg" />
    </ItemGroup>

    <ItemGroup>
      <VSIXSourceItem Include="@(IntermediateZipItem)">
        <VSIXSubPath>%(IntermediateZipItem.Filename)\%(IntermediateZipItem.Language)\%(IntermediateZipItem.OutputSubPath)\%(IntermediateZipItem.Culture)</VSIXSubPath>
      </VSIXSourceItem>
      <VSIXSourceItem Include="@(IntermediateZipProject)">
        <VSIXSubPath>%(IntermediateZipProject.Filename)\%(IntermediateZipProject.Language)\%(IntermediateZipProject.OutputSubPath)\%(IntermediateZipProject.Culture)</VSIXSubPath>
      </VSIXSourceItem>
      <VSIXSourceItem Include="@(MicrosoftMLPackage)">
        <VSIXSubPath>Packages</VSIXSubPath>
      </VSIXSourceItem>
      <VSIXSourceItem Include="@(MicrosoftMLCpuMathPackage)">
        <VSIXSubPath>Packages</VSIXSubPath>
      </VSIXSourceItem>
    </ItemGroup>
  </Target>
  
  <PropertyGroup>
    <GetVsixSourceItemsDependsOn>$(GetVsixSourceItemsDependsOn);GetVsixTemplateItems</GetVsixSourceItemsDependsOn>
  </PropertyGroup>
</Project>
